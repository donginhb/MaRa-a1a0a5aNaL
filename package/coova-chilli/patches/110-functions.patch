--- coova-chilli-1.0.13.old/conf/functions.in	2009-07-12 15:39:44.966479539 +0800
+++ coova-chilli-1.0.13.new/conf/functions.in	2009-07-12 15:37:58.156383222 +0800
@@ -57,6 +57,135 @@
 
 check_required() {
     [ -z "$HS_MODE" ]  && bailout "HS_MODE is required"
+    echo -n "Check tun module ... "
+    if [ -n "$(lsmod | grep tun)" ]; then
+        echo "installed"
+    elif [ -n "$(find /lib/modules/2.6.26/ -name tun.ko)" ]; then
+        echo -n "installing tun module ... "
+        insmod tun
+        [ -z "$(lsmod | grep tun)" ] && {
+            echo "failed ... exit"
+            exit 0
+        }
+        echo "complete"
+    else
+        echo "can't find module tun, exit"
+        exit 0
+    fi
+}
+
+extract_net()
+{
+    TMPIP=$1
+    HEADLEN=${#TMPIP}
+
+    while [ $HEADLEN -gt 0 ]
+    do
+        LASTCHAR=$(echo -n "$TMPIP" | tail -c 1)
+        [ $LASTCHAR = "." ] && {
+            TMPIP="${TMPIP}0"
+            break;
+        }
+        HEADLEN=$(($HEADLEN - 1))
+        TMPIP=$(echo -n "$TMPIP" | head -c $HEADLEN)
+    done
+    echo "$TMPIP"
+}
+
+write_chilli_conf()
+{
+ROUTER_IP=$(nvram get lan0_ipaddr)
+NET=$(extract_net $ROUTER_IP)
+WEB_IP=$(nvram show auth_server_rule 0 web_serv_ipaddr)
+WEB_PORT=$(nvram show auth_server_rule 0 web_serv_port)
+#NET=$(nvram show auth_server_rule 0 net)
+ADMIN_IP=$(nvram show auth_server_rule 0 admin_ipaddr)
+
+LOGON_PAGE=$(nvram show auth_server_rule 0 logon_page)
+STATUS_PAGE=$(nvram show auth_server_rule 0 status_page)
+LOGOFF_PAGE=$(nvram show auth_server_rule 0 logoff_page)
+
+DNS_TYPE=$(nvram show auth_server_rule 0 dns_type)
+DNS_IP=$(nvram show auth_server_rule 0 dns_ipaddr)
+
+CHILLI_CONF="/etc/chilli.conf"
+CHILLI_USER=$(nvram show auth_server_rule 0 userdb)
+[ -z "$CHILLI_USER" ] && CHILLI_USER=/etc/chilli/localusers
+
+RAD_ENABLE=$(nvram show auth_server_rule 0 radius_enable)
+RAD_IP=$(nvram show auth_server_rule 0 radius_ipaddr)
+RAD_AU_P=$(nvram show auth_server_rule 0 radius_auth_port)
+RAD_AC_P=$(nvram show auth_server_rule 0 radius_accp_port)
+RAD_SEC=$(nvram show auth_server_rule 0 radius_secret)
+NASID=$(nvram show auth_server_rule 0 nasid)
+LOCID=$(nvram show auth_server_rule 0 locid)
+RLOCNAME=$(nvram show auth_server_rule 0 rlocname)
+RLOCID=$(nvram show auth_server_rule 0 rlocid)
+
+    (cat <<EOF
+# THIS FILE IS AUTOMATICALLY GENERATED
+cmdsocket       /var/run/chilli.sock
+pidfile         /var/run/chilli.pid
+ipup		/etc/chilli/up.sh
+ipdown		/etc/chilli/down.sh
+
+net             $NET/255.255.255.0
+uamlisten       $ROUTER_IP
+uamport         $WEB_PORT
+dhcpif          br0
+uamallowed      "$ROUTER_IP,$ADMIN_IP,$WEB_IP"
+uamanydns
+
+domain lan
+dns1 $DNS_IP
+uamhomepage http://$WEB_IP:$WEB_PORT$LOGON_PAGE
+uamserver   http://$WEB_IP:$WEB_PORT$LOGON_PAGE
+wisprlogin https://coova.org/app/uam/auth
+wwwdir /etc/chilli/www
+wwwbin /etc/chilli/wwwsh
+localusers $CHILLI_USER
+locationname "My HotSpot"
+radiuslocationname My_HotSpot
+radiuslocationid isocc=,cc=,ac=,network=AXIMCom,
+#dhcpstart 30
+#dhcpend 60
+
+radiusserver1   rad01.coova.org
+radiusserver2   $WEB_IP
+radiussecret    coova-anonymous
+radiusauthport  1812
+radiusacctport  1813
+radiusnasid     nas01
+
+papalwaysok
+adminupdatefile /etc/chilli/local.conf
+
+
+EOF
+    ) > $CHILLI_CONF
+
+}
+
+write_chilli_user()
+{
+CHILLI_USER=$(nvram show auth_server_rule 0 userdb)
+[ -z "$CHILLI_USER" ] && CHILLI_USER=/etc/chilli/localusers
+echo "write $CHILLI_USER"    
+usercount=$(nvram get auth_user_rule_num)
+ind=0
+userdb=""
+echo "$usercount users"
+echo -n "" > $CHILLI_USER
+
+while [ $ind -lt $usercount ]
+do
+    name=$(nvram show auth_user_rule $ind name)
+    pass=$(nvram show auth_user_rule $ind password)
+    echo "$name:$pass"
+    echo "$name:$pass" >> $CHILLI_USER
+    ind=$(($ind + 1))
+done
+
 }
     
 configs1=
--- coova-chilli-1.0.13.old/www/ChilliLibrary.js	2009-01-31 20:32:21.000000000 +0800
+++ coova-chilli-1.0.13.new/www/ChilliLibrary.js	2009-07-12 13:14:12.981341963 +0800
@@ -102,6 +102,11 @@
 	return urlRoot;
 };
 
+chilliController.sethost = function ( host , port ) {
+	chilliController.host = host;
+	chilliController.port = port;
+};
+
 /* Default event handlers */
 chilliController.onUpdate = function ( cmd ) {
 	log('>> Default onUpdate handler. <<\n>> You should write your own. <<\n>> cmd = ' + cmd + ' <<' );
